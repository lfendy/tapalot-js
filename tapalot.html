<!DOCTYPE html>
  <head>
    <script type="text/javascript" src="./underscore-min.js"></script>
    <script type="text/javascript" src="./jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="./peg-0.7.0.min.js"></script>
    <script type="text/javascript" src="./audio_player.js"></script>
    <script type="text/javascript" src="./dragdropper.js"></script>
    <script type="text/javascript" src="./renderer.js"></script>
    <script type="text/javascript" src="./composer.js"></script>
    <script type="text/javascript" src="./conductor.js"></script>
    <link rel="stylesheet" type="text/css" media="screen" href="./tapalot_styles.css"/>
  </head>
  <body>
    <h1>Tapalot</h1>
    <div id="heartbeat" >
      HEARTBEAT
    </div>
    <input type="checkbox" id="composingModeCheckbox">Composing mode</input>
    <a href="#" id="downloadSongStructure">Download Song Text</a>
    <a href="#" id="hiddenDownloader" style="display: none;" download="song.txt">Not supposed to be shown</a>
    <div id="drop_zone">Drop Song, Grammar And Audio File Here</div>
    <div id="display"></div>
    <audio controls id="player"/>
  </body>

  <script type="text/javascript">
    (function($){
      var player = $("#player").audioPlayer();

      var parser = null;
      var rawSongStructure = null;
      var songStructure = null;

      var handleDownloadSongClick = function(evt){
        evt.preventDefault();
        evt.stopImmediatePropagation();
        var song = $("#display").renderer('renderText', songStructure);
        var blob = new Blob([song], {type: "text/plain"}); //this is a memory leak

        var downloader = $("#hiddenDownloader");
        URL.revokeObjectURL(downloader.attr("href"));

        var url = URL.createObjectURL(blob);
        downloader.attr("href", url);

        downloader[0].click(); //nasty hack to download file with name
      };

      var changeToComposingMode = function(){
        $("#display").composer('enabled', true);
      };

      var changeToPlayingMode = function(){
        $("#display").composer('enabled', false);
      };

      var handleComposingModeChange = function(evt){
          if($(evt.target).is(":checked")){
            changeToComposingMode();
          } else {
            changeToPlayingMode();
          }
      };

      var highlightLine = function(evt, idxSection, idxLine){
        $("#display").renderer("highlightLine", evt.target, idxSection, idxLine);
      };

      var rerenderLine = function(evt, songLine){
        $("#display").children().removeClass("pulse");
        $(evt.target).addClass("pulse");
        $("#display").renderer("rerenderLine", evt.target, songLine);
      };

      var parseSong = function(){
        if(parser != null && rawSongStructure != null){
          songStructure = parser.parse(rawSongStructure);
          $("#display")
            .renderer(songStructure)
            .composer(songStructure, player)
            .on("rerenderLine", rerenderLine)
            .conductor(songStructure, player)
            .on("highlightLine", highlightLine);
          window.songStructure = songStructure;
        }
      };

      var handleReceivedAudio = function(evt, data){
        console.log("received audio");
        player.audioPlayer("setSongSource", data.url);
      };

      var handleReceivedGrammar = function(evt, data){
        console.log("received grammar");
        var grammar = data.contents;
        parser = PEG.buildParser(grammar);
        parseSong();
        window.grammar = grammar;
        window.parser = parser;
      };

      var handleReceivedSongStructure = function(evt, data){
        console.log("received song structure");
        rawSongStructure = data.contents;
        parseSong();
        window.rawSongStructure = rawSongStructure;
      };

      $("#drop_zone")
        .dragdropper()
        .on("receivedMP3", handleReceivedAudio)
        .on("receivedPEG", handleReceivedGrammar)
        .on("receivedTXT", handleReceivedSongStructure);

      $("#composingModeCheckbox")
        .on("change", handleComposingModeChange);

      $("#downloadSongStructure")
        .on("click", handleDownloadSongClick);

     })(jQuery);
  </script>
</html>
