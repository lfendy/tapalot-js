<!DOCTYPE html>
  <head>
    <script type="text/javascript" src="./underscore-min.js"></script>
    <script type="text/javascript" src="./jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="./peg-0.7.0.min.js"></script>
    <script type="text/javascript" src="./audio_player.js"></script>
    <script type="text/javascript" src="./dragdropper.js"></script>
    <script type="text/javascript" src="./renderer.js"></script>
    <script type="text/javascript" src="./composer.js"></script>
    <script type="text/javascript" src="./conductor.js"></script>
    <link rel="stylesheet" type="text/css" media="screen" href="./tapalot_styles.css"/>
  </head>
  <body>
    <div id="heartbeat" class="heartbeat">
      HEARTBEAT
    </div>
    <input type="checkbox" id="composingModeCheckbox">Composing mode</input>
    <a href="#" id="downloadSongStructure">Download Song Text</a>
    <a href="#" id="hiddenDownloader" style="display: none;" download="song.txt">Not supposed to be shown</a>
    <input type="button" id="play" value="play"/>
    <input type="button" id="pause" value="pause"/>
    <div id="display" class="scrollable"></div>
    <div id="drop_zone">Drop Song, Grammar And Audio File Here</div>
    <audio controls id="player"/>
  </body>

  <script type="text/javascript">
    (function($){
      var player = $("#player").audioPlayer();

      var parser = null;
      var rawSongStructure = null;
      var songStructure = null;
      const ANIMATION_DELAY = 0.7;

      var handleDownloadSongClick = function(evt){
        evt.preventDefault();
        evt.stopImmediatePropagation();
        var song = $("#display").renderer('renderText', songStructure);
        var blob = new Blob([song], {type: "text/plain"}); //this is a memory leak

        var downloader = $("#hiddenDownloader");
        URL.revokeObjectURL(downloader.attr("href"));

        var url = URL.createObjectURL(blob);
        downloader.attr("href", url);

        downloader[0].click(); //nasty hack to download file with name
      };

      var changeToComposingMode = function(){
        $("#display").composer('enabled', true);
      };

      var changeToPlayingMode = function(){
        $("#display").composer('enabled', false);
      };

      var handleComposingModeChange = function(evt){
          if($(evt.target).is(":checked")){
            changeToComposingMode();
          } else {
            changeToPlayingMode();
          }
      };

      var $heartbeat = $("#heartbeat");
      var handleHeartbeat = function(evt, whatToShow){
        $heartbeat.text(whatToShow);
      }

      var handleHighlightLine = function(evt, idxSection, idxLine){
        $("#display").renderer("highlightLine", idxSection, idxLine);
      };

      var handleRerenderLine = function(evt, songLine){
        var $target = $(evt.target);
        $("#display").children().removeClass("pulse");
        $("#display").renderer("rerenderLine", $target, songLine);
        $("#" + $target.attr("id")).addClass("pulse");
      };

      var parseSong = function(){
        if(parser != null && rawSongStructure != null){
          songStructure = parser.parse(rawSongStructure);
          $("#display")
            .renderer(songStructure)
            .composer(songStructure, player)
            .on("rerenderLine", handleRerenderLine)
            .conductor(songStructure, player, (-1 * ANIMATION_DELAY))
            .on("highlightLine", handleHighlightLine)
            .on("heartbeat", handleHeartbeat);
          window.songStructure = songStructure;
        }
      };

      var handleReceivedAudio = function(evt, data){
        console.log("received audio");
        player.audioPlayer("setSongSource", data.url);
      };

      var handleReceivedGrammar = function(evt, data){
        console.log("received grammar");
        var grammar = data.contents;
        parser = PEG.buildParser(grammar);
        parseSong();
        window.grammar = grammar;
        window.parser = parser;
      };

      var handleReceivedSongStructure = function(evt, data){
        console.log("received song structure");
        rawSongStructure = data.contents;
        parseSong();
        window.rawSongStructure = rawSongStructure;
      };

      $("#drop_zone")
        .dragdropper()
        .on("receivedMP3", handleReceivedAudio)
        .on("receivedPEG", handleReceivedGrammar)
        .on("receivedTXT", handleReceivedSongStructure);

      $("#composingModeCheckbox")
        .on("change", handleComposingModeChange);

      $("#downloadSongStructure")
        .on("click", handleDownloadSongClick);

      $("#play")
        .on("click", function(){
            if($("#composingModeCheckbox").is(":checked")){
              $("#player").audioPlayer("play");
            } else {
              $("#display").conductor("play");
            }
        });

      $("#pause")
        .on("click", function(){
            if($("#composingModeCheckbox").is(":checked")){
              $("#player").audioPlayer("pause");
            } else {
              $("#display").conductor("pause");
            }
        });

     })(jQuery);
  </script>
</html>
